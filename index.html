<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Transaksi Agen Harian</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald 500
                        'secondary': '#facc15', // Amber 400
                        'danger': '#ef4444', // Red 500
                        'info': '#3b82f6', // Blue 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Styling untuk memastikan tidak ada Cumulative Layout Shift (CLS) */
        [v-cloak] { display: none; }
        .summary-row { transition: all 0.3s ease; }
        .summary-row:hover { background-color: #f3f4f6; }
        .tab-button.active {
            border-bottom-color: #10b981;
            font-weight: 600;
            color: #10b981;
        }
        .summary-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen p-4 sm:p-8">

    <!-- Kontainer Utama -->
    <div id="app" class="max-w-7xl mx-auto space-y-8" v-cloak>
        
        <!-- Header Aplikasi -->
        <header class="text-center py-4 bg-white rounded-xl shadow-md">
            <h1 class="text-3xl font-bold text-gray-800">Rekonsiliasi Harian</h1>
            <p class="text-gray-500">Rekapan transaksi harian Anggun Cell</p>
        </header>

        <!-- Pesan Status & Error -->
        <div v-if="statusMessage" :class="['p-4 rounded-lg text-sm font-medium transition-all duration-300', statusType === 'success' ? 'bg-primary/10 text-primary border border-primary' : 'bg-danger/10 text-danger border border-danger']">
            {{ statusMessage }}
        </div>

        <!-- Tabs: Input Data vs Ringkasan Harian -->
        <div class="flex border-b border-gray-200 bg-white rounded-xl shadow-md p-2">
            <button @click="activeTab = 'input'" :class="['tab-button px-4 py-2 text-lg transition-colors border-b-2', activeTab === 'input' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700']">
                Input Transaksi
            </button>
            <button @click="activeTab = 'summary'; loadSummary()" :class="['tab-button px-4 py-2 text-lg transition-colors border-b-2', activeTab === 'summary' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700']">
                Ringkasan Harian
            </button>
        </div>

        <!-- === Tab Input Transaksi === -->
        <div v-if="activeTab === 'input'" class="bg-white p-6 rounded-xl summary-card">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Input Transaksi Baru</h2>
            
            <form @submit.prevent="submitData" class="space-y-6">
                
                <!-- Pilihan Sheet (Channel) -->
                <div>
                    <label for="sheetName" class="block text-sm font-medium text-gray-700 mb-1">Pilih Channel/Sheet</label>
                    <select id="sheetName" v-model="form.sheetName" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="" disabled>-- Pilih Salah Satu --</option>
                        <option v-for="sheet in sheets" :value="sheet">{{ sheet }}</option>
                    </select>
                </div>

                <!-- Input Field: Produk & Identitas -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="produk" class="block text-sm font-medium text-gray-700 mb-1">Produk</label>
                        <input type="text" id="produk" v-model="form.produk" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Pulsa, Paket Data, Token Listrik, dll.">
                    </div>
                    <div>
                        <label for="identitas" class="block text-sm font-medium text-gray-700 mb-1">Nama User/Identitas</label>
                        <input type="text" id="identitas" v-model="form.identitas" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Nama pelanggan atau nomor HP/ID">
                    </div>
                </div>

                <!-- Status Transaksi -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status Transaksi</label>
                    <select id="status" v-model="form.status" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="Lunas">Lunas</option>
                        <option value="Terhutang">Terhutang</option>
                    </select>
                </div>

                <!-- Input Field: Harga -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="hargaChannel" class="block text-sm font-medium text-gray-700 mb-1">Harga Channel (Modal)</label>
                        <input type="number" id="hargaChannel" v-model.number="form.hargaChannel" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="50000">
                    </div>
                    <div>
                        <label for="hargaJual" class="block text-sm font-medium text-gray-700 mb-1">Harga Jual (Diterima)</label>
                        <input type="number" id="hargaJual" v-model.number="form.hargaJual" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="55000">
                    </div>
                </div>

                <!-- Pembayaran Diterima -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="cashDiterimaAgen" class="block text-sm font-medium text-gray-700 mb-1">Cash Diterima Agen (I)</label>
                        <input type="number" id="cashDiterimaAgen" v-model.number="form.cashDiterimaAgen" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="0">
                        <p class="text-xs text-gray-500 mt-1">Hanya diisi jika pembayaran berupa uang tunai.</p>
                    </div>
                    <div>
                        <label for="onlineMasuk" class="block text-sm font-medium text-gray-700 mb-1">Online Masuk (J)</label>
                        <input type="number" id="onlineMasuk" v-model.number="form.onlineMasuk" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="0">
                        <p class="text-xs text-gray-500 mt-1">Hanya diisi jika transfer online.</p>
                    </div>
                </div>

                <!-- Jumlah Terhutang (Hanya muncul jika Status Terhutang) -->
                <div v-if="form.status === 'Terhutang'">
                    <label for="jumlahTerhutang" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Terhutang (K)</label>
                    <input type="number" id="jumlahTerhutang" v-model.number="form.jumlahTerhutang" required class="w-full p-2 border border-danger rounded-lg focus:ring-danger focus:border-danger" placeholder="5000">
                    <p class="text-xs text-danger mt-1">Isi sisa yang belum dibayar pelanggan.</p>
                </div>

                <!-- Tombol Submit -->
                <button type="submit" :disabled="isLoading" class="w-full py-3 px-4 bg-primary text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors disabled:opacity-50 flex items-center justify-center">
                    <svg v-if="isLoading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    {{ isLoading ? 'Mengirim Data...' : 'Submit Transaksi' }}
                </button>
            </form>
        </div>

        <!-- === Tab Ringkasan Harian === -->
        <div v-if="activeTab === 'summary'" class="bg-white p-6 rounded-xl summary-card">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Ringkasan Transaksi Harian</h2>
            
            <div class="flex items-center space-x-2 mb-6">
                <label for="summaryDate" class="text-gray-700 font-medium">Pilih Tanggal:</label>
                <input type="date" id="summaryDate" v-model="summaryDate" @change="loadSummary" class="p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <button @click="loadSummary" :disabled="isLoadingSummary" class="bg-info text-white p-2 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50">
                    Muat Ulang
                </button>
            </div>

            <div v-if="isLoadingSummary" class="flex justify-center items-center h-48">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3 text-gray-500">Memuat data ringkasan...</span>
            </div>

            <div v-else-if="summaryData">
                <div v-if="summaryData.GrandTotal.totalHargaChannel === 'Rp 0'" class="p-4 bg-yellow-100 text-yellow-800 rounded-lg border border-yellow-300">
                    Tidak ada data transaksi untuk tanggal {{ formatDate(summaryDate) }}.
                </div>

                <div v-else class="space-y-6">
                    <!-- Grand Total -->
                    <div class="p-5 bg-primary/10 rounded-xl border-l-4 border-primary shadow-lg">
                        <h3 class="text-xl font-bold text-primary mb-3 flex items-center justify-between">
                            GRAND TOTAL Harian
                        </h3>
                        <table class="w-full text-sm">
                            <tbody>
                                <!-- Keuntungan -->
                                <tr class="summary-row font-bold text-lg text-gray-800">
                                    <td class="p-2 w-3/5">Total Keuntungan Bersih</td>
                                    <td class="p-2 text-right text-primary">{{ summaryData.GrandTotal.totalKeuntungan }}</td>
                                </tr>
                                <!-- Modal -->
                                <tr class="summary-row">
                                    <td class="p-2 w-3/5 text-gray-600">Total Modal (Harga Channel)</td>
                                    <td class="p-2 text-right text-gray-600">{{ summaryData.GrandTotal.totalHargaChannel }}</td>
                                </tr>
                                <!-- Metrik Baru -->
                                <tr class="summary-row">
                                    <td class="p-2 w-3/5 text-gray-600">Total Cash Diterima Agen (I)</td>
                                    <td class="p-2 text-right text-gray-600">{{ summaryData.GrandTotal.totalCashAgen }}</td>
                                </tr>
                                <tr class="summary-row">
                                    <td class="p-2 w-3/5 text-gray-600">Total Online Masuk (J)</td>
                                    <td class="p-2 text-right text-gray-600">{{ summaryData.GrandTotal.totalOnlineMasuk }}</td>
                                </tr>
                                <tr class="summary-row">
                                    <td class="p-2 w-3/5 text-gray-600">Total Jumlah Terhutang (K)</td>
                                    <td class="p-2 text-right text-danger font-semibold">{{ summaryData.GrandTotal.totalTerhutang }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Detail Per Channel -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-700 border-b pb-2">Detail Per Channel Transaksi</h3>
                        <div v-for="sheet in sheets" :key="sheet" v-if="summaryData[sheet] && summaryData[sheet].totalHargaChannel !== 'Rp 0'" class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <h4 class="text-lg font-bold text-gray-800 mb-2">{{ sheet }}</h4>
                            <table class="w-full text-sm">
                                <tbody>
                                    <!-- Keuntungan -->
                                    <tr class="summary-row font-medium">
                                        <td class="p-1 w-3/5">Keuntungan</td>
                                        <td class="p-1 text-right text-primary">{{ summaryData[sheet].totalKeuntungan }}</td>
                                    </tr>
                                    <!-- Modal -->
                                    <tr class="summary-row">
                                        <td class="p-1 w-3/5 text-gray-600">Modal (Harga Channel)</td>
                                        <td class="p-1 text-right text-gray-600">{{ summaryData[sheet].totalHargaChannel }}</td>
                                    </tr>
                                    <!-- Metrik Baru -->
                                    <tr class="summary-row">
                                        <td class="p-1 w-3/5 text-gray-600">Cash Diterima Agen (I)</td>
                                        <td class="p-1 text-right text-gray-600">{{ summaryData[sheet].totalCashAgen }}</td>
                                    </tr>
                                    <tr class="summary-row">
                                        <td class="p-1 w-3/5 text-gray-600">Online Masuk (J)</td>
                                        <td class="p-1 text-right text-gray-600">{{ summaryData[sheet].totalOnlineMasuk }}</td>
                                    </tr>
                                    <tr class="summary-row">
                                        <td class="p-1 w-3/5 text-gray-600">Jumlah Terhutang (K)</td>
                                        <td class="p-1 text-right text-danger font-semibold">{{ summaryData[sheet].totalTerhutang }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="!summaryDate" class="p-4 bg-blue-100 text-blue-800 rounded-lg border border-blue-300">
                Silakan pilih tanggal untuk memuat ringkasan transaksi harian.
            </div>
            
            <div v-else-if="!summaryData && !isLoadingSummary" class="p-4 bg-red-100 text-red-800 rounded-lg border border-red-300">
                Error Memuat Ringkasan. Cek Logs GET Apps Script Anda.
            </div>
        </div>
        
    </div>

    <!-- Script Vue dan Logic Aplikasi -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script>
        const VUE_APP = new Vue({
            el: '#app',
            data: {
                // GANTI URL INI DENGAN URL DEPLOYMENT APPS SCRIPT ANDA
                APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbw2S-Zxw77lEvfjc2NFwiqEDBovZHlwiODQkUeCATTPc5VibqBSc50iZMCGKqL6vW2arQ/exec', 
                
                activeTab: 'input',
                sheets: ['Flip', 'Gopay', 'Buku Agen', 'QRIS'],
                isLoading: false,
                isLoadingSummary: false,
                statusMessage: '',
                statusType: 'success',
                summaryDate: new Date().toISOString().substring(0, 10), // Tanggal hari ini
                summaryData: null,
                form: {
                    sheetName: '',
                    produk: '',
                    identitas: '',
                    status: 'Lunas',
                    hargaChannel: null,
                    hargaJual: null,
                    cashDiterimaAgen: 0,
                    onlineMasuk: 0,
                    jumlahTerhutang: 0,
                    channel: 'Manual'
                }
            },
            methods: {
                // Menampilkan pesan status selama 5 detik
                setStatusMessage(message, type = 'success') {
                    this.statusMessage = message;
                    this.statusType = type;
                    setTimeout(() => {
                        this.statusMessage = '';
                    }, 5000);
                },

                // Reset semua field form ke nilai default
                resetForm() {
                    this.form = {
                        sheetName: this.form.sheetName, // Pertahankan sheetName terakhir
                        produk: '',
                        identitas: '',
                        status: 'Lunas',
                        hargaChannel: null,
                        hargaJual: null,
                        cashDiterimaAgen: 0,
                        onlineMasuk: 0,
                        jumlahTerhutang: 0,
                        channel: 'Manual'
                    };
                },

                // Mengirim data transaksi ke Apps Script
                async submitData() {
                    if (this.isLoading) return;
                    
                    // Validasi khusus untuk Terhutang
                    if (this.form.status === 'Terhutang' && (this.form.jumlahTerhutang === null || this.form.jumlahTerhutang <= 0)) {
                        this.setStatusMessage('Harap isi Jumlah Terhutang jika Status Transaksi adalah Terhutang.', 'danger');
                        return;
                    }

                    if (this.APPS_SCRIPT_URL === 'GANTI_DENGAN_URL_DEPLOYMENT_ANDA') {
                         this.setStatusMessage('ERROR: Harap ganti APPS_SCRIPT_URL di dalam script code ini dengan URL Deployment Anda.', 'danger');
                         return;
                    }

                    this.isLoading = true;
                    this.statusMessage = 'Mengirim data transaksi...';
                    this.statusType = 'info';

                    const formData = new URLSearchParams();
                    formData.append('action', 'submitData');
                    
                    // Append semua data form
                    for (const key in this.form) {
                        // Pastikan nilai terhutang dikirim hanya jika statusnya Terhutang
                        if (key === 'jumlahTerhutang' && this.form.status !== 'Terhutang') {
                           formData.append(key, 0); // Kirim 0 jika Lunas
                        } else if (this.form[key] !== null) {
                            // Kirim nilai angka sebagai string tanpa pemisah ribuan
                            formData.append(key, String(this.form[key])); 
                        }
                    }

                    try {
                        const response = await fetch(this.APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors', // Penting untuk Apps Script POST
                            body: formData
                        });

                        // Karena 'no-cors', kita tidak bisa membaca response JSON. 
                        // Kita asumsikan sukses jika fetch tidak error.
                        this.setStatusMessage(`Sukses! Transaksi ke sheet ${this.form.sheetName} berhasil dicatat.`, 'success');
                        this.resetForm();
                        
                    } catch (error) {
                        console.error('Submit Error:', error);
                        this.setStatusMessage('Gagal mengirim data. Cek URL atau koneksi Anda. Detail: ' + error.message, 'danger');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // Memuat ringkasan harian dari Apps Script
                async loadSummary() {
                    if (this.isLoadingSummary || !this.summaryDate) return;
                    
                    if (this.APPS_SCRIPT_URL === 'GANTI_DENGAN_URL_DEPLOYMENT_ANDA') {
                         this.setStatusMessage('ERROR: Harap ganti APPS_SCRIPT_URL di dalam script code ini dengan URL Deployment Anda.', 'danger');
                         return;
                    }

                    this.isLoadingSummary = true;
                    this.summaryData = null; // Clear previous data
                    this.statusMessage = 'Memuat ringkasan transaksi...';
                    this.statusType = 'info';

                    try {
                        const url = `${this.APPS_SCRIPT_URL}?action=getSummary&date=${this.summaryDate}`;
                        
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        this.summaryData = result;
                        this.setStatusMessage('Ringkasan harian berhasil dimuat.', 'success');

                    } catch (error) {
                        console.error('Load Summary Error:', error);
                        this.setStatusMessage(`Error Memuat Ringkasan. Detail: ${error.message}`, 'danger');
                        this.summaryData = { GrandTotal: { totalHargaChannel: 'Rp 0' } }; // Set to 0 to show empty message
                    } finally {
                        this.isLoadingSummary = false;
                    }
                },
                
                // Helper untuk format tanggal tampilan
                formatDate(dateString) {
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date(dateString).toLocaleDateString('id-ID', options);
                }
            },
            mounted() {
                // Muat ringkasan saat pertama kali dashboard dibuka di tab summary
                if (this.activeTab === 'summary') {
                    this.loadSummary();
                }
            }
        });
    </script>
</body>
</html>
